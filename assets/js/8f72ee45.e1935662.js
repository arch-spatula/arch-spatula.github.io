"use strict";(self.webpackChunkarch_spatula_github_io=self.webpackChunkarch_spatula_github_io||[]).push([[93417],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>d});var r=t(67294);function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,r,s=function(e,n){if(null==e)return{};var t,r,s={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(s[t]=e[t]);return s}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var l=r.createContext({}),i=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},u=function(e){var n=i(e.components);return r.createElement(l.Provider,{value:n},e.children)},p="mdxType",k={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,s=e.mdxType,o=e.originalType,l=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=i(t),m=s,d=p["".concat(l,".").concat(m)]||p[m]||k[m]||o;return t?r.createElement(d,a(a({ref:n},u),{},{components:t})):r.createElement(d,a({ref:n},u))}));function d(e,n){var t=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var o=t.length,a=new Array(o);a[0]=m;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c[p]="string"==typeof e?e:s,a[1]=c;for(var i=2;i<o;i++)a[i]=t[i];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},65247:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>k,frontMatter:()=>o,metadata:()=>c,toc:()=>i});var r=t(87462),s=(t(67294),t(3905));const o={title:"refresh token\uacfc access token \uc774\ud574\ud558\uae30",authors:["arch-spatula"],tags:["token","auth","refresh token","access token"],description:"refresh token\uacfc access token\uc744 \uc774\ud574\ud558\uae30 \uc704\ud574 \ud588\ub358 \ub178\ub825\uc785\ub2c8\ub2e4.",toc_max_heading_level:6},a="refresh token\uacfc access token \uc774\ud574\ud558\uae30",c={permalink:"/blog/2023/06/02/",editUrl:"https://github.com/arch-spatula/arch-spatula.github.io/blob/dev/blog/2023-06-02.md",source:"@site/blog/2023-06-02.md",title:"refresh token\uacfc access token \uc774\ud574\ud558\uae30",description:"refresh token\uacfc access token\uc744 \uc774\ud574\ud558\uae30 \uc704\ud574 \ud588\ub358 \ub178\ub825\uc785\ub2c8\ub2e4.",date:"2023-06-02T00:00:00.000Z",formattedDate:"2023\ub144 6\uc6d4 2\uc77c",tags:[{label:"token",permalink:"/blog/tags/token"},{label:"auth",permalink:"/blog/tags/auth"},{label:"refresh token",permalink:"/blog/tags/refresh-token"},{label:"access token",permalink:"/blog/tags/access-token"}],readingTime:10.91,hasTruncateMarker:!0,authors:[{name:"arch-spatula",title:"Cook-Book \ub9ce\uc774 \ub9cc\ub4ed\ub2c8\ub2e4",url:"https://github.com/arch-spatula",imageURL:"https://github.com/arch-spatula.png",key:"arch-spatula"}],frontMatter:{title:"refresh token\uacfc access token \uc774\ud574\ud558\uae30",authors:["arch-spatula"],tags:["token","auth","refresh token","access token"],description:"refresh token\uacfc access token\uc744 \uc774\ud574\ud558\uae30 \uc704\ud574 \ud588\ub358 \ub178\ub825\uc785\ub2c8\ub2e4.",toc_max_heading_level:6},prevItem:{title:"\uc5d0\ub7ec\ub85c\uadf8: oak testing\uc5d0\uc11c get\uacfc set\uc740 \uc11c\ub85c \uad00\ub828\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.",permalink:"/blog/2023/06/03/"},nextItem:{title:"\ub9ac\uc561\ud2b8 \uac1c\ubc1c \ucc29\uc218",permalink:"/blog/2023/06/01/"}},l={authorsImageUrls:[void 0]},i=[{value:"Custom hook\uc5d0 \ub300\ud55c \uad00\uc2ec\uc0ac \ubd84\ub9ac",id:"custom-hook\uc5d0-\ub300\ud55c-\uad00\uc2ec\uc0ac-\ubd84\ub9ac",level:2},{value:"refresh token access token",id:"refresh-token-access-token",level:2},{value:"\uc751\ub2f5 \uc608\uc2dc",id:"\uc751\ub2f5-\uc608\uc2dc",level:3},{value:"login",id:"login",level:3},{value:"refresh",id:"refresh",level:3},{value:"logout",id:"logout",level:3},{value:"Deno \ubc84\uc804",id:"deno-\ubc84\uc804",level:3},{value:"deps",id:"deps",level:2}],u={toc:i},p="wrapper";function k(e){let{components:n,...t}=e;return(0,s.kt)(p,(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"refresh token\uacfc access token\uc744 \uc774\ud574\ud558\uae30 \uc704\ud574 \ud588\ub358 \ub178\ub825\uc785\ub2c8\ub2e4."),(0,s.kt)("h2",{id:"custom-hook\uc5d0-\ub300\ud55c-\uad00\uc2ec\uc0ac-\ubd84\ub9ac"},"Custom hook\uc5d0 \ub300\ud55c \uad00\uc2ec\uc0ac \ubd84\ub9ac"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-tsx"},"import { Button, Input } from '../../Components';\nimport { useInput } from '../../hooks';\n\nfunction SignIn() {\n  const { inputVal: emailValue, changeInputVal: changeEmail } = useInput();\n\n  return (\n    <div>\n      <h1>Sign In</h1>\n      <Input type=\"email\" onChange={changeEmail} value={emailValue} />\n      <Button\n        onClick={(e) => {\n          console.log(e.target);\n        }}\n      >\n        Sign In\n      </Button>\n    </div>\n  );\n}\n\nexport { SignIn };\n")),(0,s.kt)("p",null,"\uc774\ub7f0 \ucef4\ud3ec\ub10c\ud2b8\uac00 \uc788\uc2b5\ub2c8\ub2e4. \ub85c\uadf8\uc778 \ud398\uc774\uc9c0\ub97c \ub2f4\ub2f9\ud558\uace0 \uc788\uc2b5\ub2c8\ub2e4. \ub51c\ub808\ub9c8\ub294 \uc774\uac83\uc785\ub2c8\ub2e4. \ud398\uc774\uc9c0\uc5d0 \uadf8\ub300\ub85c \uc791\uc131\ud574\ub3c4 \ub2f9\uc5f0\ud788 \ub3d9\uc791\ud558\ub294\ub370 \ub9c8\ud06c\uc5c5\uacfc \ucee8\ud2b8\ub864\ub7ec\uc758 \ubd84\ub9ac\uac00 \uc548 \uc774\ub8e8\uc5b4\uc9d1\ub2c8\ub2e4. hook\uc774 \ucee8\ud2b8\ub864\ub7ec \uc5ed\ud560\uc744 \ud560 \uc218 \uc788\uac8c \ud574\uc57c \ud558\ub294\ub370 \ubb38\uc81c\ub294 \uc911\ubcf5\ud558\ub294 \ub85c\uc9c1\uc774 \uc544\ub2c8\ub77c\ub294 \uc810\uc785\ub2c8\ub2e4."),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://martinfowler.com/bliki/PresentationDomainDataLayering.html"},"Presentation Domain Data Layering - Martin Fowler")),(0,s.kt)("p",null,"\uc774\ubbf8\uc9c0\uc758 \uc704\uce58\ub97c \ubcf4\uba74 \uc804\uc6a9 \ub85c\uc9c1\uc744 \uac19\uc774 \ubc30\uce58\ud574\ub3c4 \uad1c\ucc2e\uc744 \uac83 \uac19\uc2b5\ub2c8\ub2e4. \ub85c\uadf8\uc778 \uae30\ub2a5\uc744 ",(0,s.kt)("inlineCode",{parentName:"p"},"useSignIn"),"\uc73c\ub85c \uac19\uc740 page \ubaa8\ub4c8\uc5d0 \ubc30\uce58\ud558\uace0 \ud574\uacb0\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uadf8\ub9ac\uace0 useSignIn\uc5d0\uc11c \uc804\uc6a9\uc73c\ub85c \uc0ac\uc6a9\ud560 Model \ud074\ub798\uc2a4\ub3c4 \uc815\uc758\ud574 \ub458 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,s.kt)("p",null,"\ud398\uc774\uc9c0 \ub2e8\uc704\ub85c \ud504\ub808\uc820\ud14c\uc774\uc158\uacfc \ub3c4\uba54\uc778\uc744 \ubd88\ub9ac\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."),(0,s.kt)("h2",{id:"refresh-token-access-token"},"refresh token access token"),(0,s.kt)("p",null,"\ubc31\uc5d4\ub4dc \uc5d4\uc9c0\ub2c8\uc5b4\ub9c1 \uc911\uc5d0 \uc624\ud0c0\ub97c \ub098\uc911\uc5d0 \ubc1c\uacac\ud588\uc2b5\ub2c8\ub2e4."),(0,s.kt)("p",null,"refresh access token\ub97c \uad6c\ud604\ud558\ub294 \uac83\uc774 \uc88b\uc744 \uac83 \uac19\uc2b5\ub2c8\ub2e4."),(0,s.kt)("iframe",{class:"codepen",src:"https://www.youtube.com/embed/iD49_NIQ-R4",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowfullscreen:!0}),(0,s.kt)("p",null,"\uac1c\ub150\uc785\ub2c8\ub2e4."),(0,s.kt)("p",null,"\uc0ac\uc6a9\uc790\uac00 \ub85c\uadf8\uc778\ud558\uba74 \ud558\ub098\ub294 \ucfe0\ud0a4\uc5d0 \uc800\uc7a5\ud558\uace0 \ub2e4\ub978 \ud558\ub098\ub294 \uc77c\ubc18 \uba54\ubaa8\ub9ac\uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4."),(0,s.kt)("p",null,"JWT Bearer \ud1a0\ud070\uc740 \uc2a4\ud1a0\ub9ac\uc9c0\uc5d0\uc11c \ub2f4\uace0 \uc788\ub2e4\uac00 Header\ub85c \uc124\uc815\ud574\uc11c \uc694\uccad\uc744 \ubcf4\ub0b4\uba74 \ub429\ub2c8\ub2e4. \uc774\uac83\uc740 access token\uc785\ub2c8\ub2e4. \ub9cc\ub8cc \ud639\uc740 \uc720\ud6a8\ud558\uc9c0 \uc54a\uc73c\uba74 \ub9c9\uc73c\uba74 \ub429\ub2c8\ub2e4."),(0,s.kt)("p",null,"refresh \ud1a0\ud070\uc740 cookie\ub85c \uc124\uc815\ud569\ub2c8\ub2e4."),(0,s.kt)("p",null,"\uc774\ub807\uac8c \ud558\uba74 \uc7a5\uc810\uc740 \uc0c8\ub85c\uace0\uce68 \ubb38\uc81c\ub97c \ud574\uacb0\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc0c8\ub85c\uace0\uce68\ud558\uba74 refresh \ud1a0\ud070\uc740 \uc794\uc874\ud558\uace0 access token\uc740 \uc0ac\ub77c\uc9d1\ub2c8\ub2e4."),(0,s.kt)("p",null,"\uc0ac\uc6a9\uc790\ub294 refresh \ud1a0\ud070\uc744 \uc11c\ubc84\uc5d0 \ubcf4\ub0b4\uba74 \uc11c\ubc84\ub294 access \ud1a0\ud070\uc744 \uc751\ub2f5\ud569\ub2c8\ub2e4. \uadf8\ub9ac\uace0 access \ud1a0\ud070\uc73c\ub85c \uc11c\ubc84\uc5d0 \uc694\uccad\uc744 \ubcf4\ub0b4\uace0 \ub370\uc774\ud130\ub97c \ubc1b\ub294 \ubc29\uc2dd\uc785\ub2c8\ub2e4."),(0,s.kt)("p",null,"refresh \ud1a0\ud070 \uc790\uccb4\ub85c \uc694\uccad\uc744 \ud65c\uc6a9\ud558\uba74 \uc758\ubbf8\ub294 \ud06c\uac8c \uc5c6\uc2b5\ub2c8\ub2e4. \ud574\ucee4\ub294 refresh\uc758 \uc751\ub2f5\uc744 \ud65c\uc6a9\ud560 \uc218 \uc5c6\uae30 \ub54c\ubb38\uc785\ub2c8\ub2e4."),(0,s.kt)("iframe",{class:"codepen",src:"https://www.youtube.com/embed/9eKIYjcPXp4",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowfullscreen:!0}),(0,s.kt)("p",null,"\uc5ec\uae30\uc11c\ub294 access\uc774 \ub9cc\ub8cc\ub429\ub2c8\ub2e4. \uadf8\ub9ac\uace0 refresh \ud1a0\ud070\uc744 \ubc1b\uc544\uc11c \uac31\uc2e0\ud569\ub2c8\ub2e4."),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://www.rfc-editor.org/rfc/rfc6749"},"RFC \ud1a0\ud070 \uc2a4\ud399 - The OAuth 2.0 Authorization Framework")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"  +--------+                                           +---------------+\n  |        |--(A)------- Authorization Grant ---------\x3e|               |\n  |        |                                           |               |\n  |        |<-(B)----------- Access Token -------------|               |\n  |        |               & Refresh Token             |               |\n  |        |                                           |               |\n  |        |                            +----------+   |               |\n  |        |--(C)---- Access Token ----\x3e|          |   |               |\n  |        |                            |          |   |               |\n  |        |<-(D)- Protected Resource --| Resource |   | Authorization |\n  | Client |                            |  Server  |   |     Server    |\n  |        |--(E)---- Access Token ----\x3e|          |   |               |\n  |        |                            |          |   |               |\n  |        |<-(F)- Invalid Token Error -|          |   |               |\n  |        |                            +----------+   |               |\n  |        |                                           |               |\n  |        |--(G)----------- Refresh Token -----------\x3e|               |\n  |        |                                           |               |\n  |        |<-(H)----------- Access Token -------------|               |\n  +--------+           & Optional Refresh Token        +---------------+\n")),(0,s.kt)("p",null,"\ud1a0\ud070 2\uac1c\ub97c \uc800\uc7a5\ud558\uace0 API \ud638\ucd9c\ud560 \ub54c\ub294 Access \ud1a0\ud070\uc744 \uc81c\ucd9c\ud569\ub2c8\ub2e4. \ud558\uc9c0\ub9cc \ub9cc\ub8cc\ub418\ub294 \uacbd\uc6b0\uac00 \uc788\uc2b5\ub2c8\ub2e4. token error\uac00 \ubc1c\uc0dd\ud558\uba74 access \ud1a0\ud070\uc758 \uc218\uba85\uc774 \ub05d\ub0ac\ub2e4\ub294 \uac83\uc785\ub2c8\ub2e4. \uc774 \ub54c refresh \ud1a0\ud070\uc744 \ubcf4\ub0b4\uace0 Access \ud1a0\ud070\uc744 \uac31\uc2e0\ud569\ub2c8\ub2e4."),(0,s.kt)("p",null,(0,s.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/84452145/243898637-49e4124f-a13a-451c-8ad9-c29f78657b88.png",alt:"\ud1a0\ud070 \uc218\uba85\ubcc4 \uc751\ub2f5"})),(0,s.kt)("p",null,"\ud1a0\ud070\uc758 \uc218\uba85\ubcc4\ub85c \uc11c\ubc84\uac00 \ucc98\ub9ac\ud560 \uc751\ub2f5\uc740 \uc774\ub807\uac8c \ubcfc \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ubcf4\ud1b5 access token\uc758 \uac31\uc2e0 \uc8fc\uae30\ub294 \uc9e7\uac8c \ub450\uace0 refresh token\uc740 \uae38\uac8c \ub461\ub2c8\ub2e4. \uadf8\ub9ac\uace0 \uac31\uc2e0\uc774 \ud544\uc694\ud558\uba74 refresh token\uc744 \uc11c\ubc84\uc5d0 \uc7ac\ucd9c\ud558\uace0 \uac31\uc2e0\ud569\ub2c8\ub2e4."),(0,s.kt)("h3",{id:"\uc751\ub2f5-\uc608\uc2dc"},"\uc751\ub2f5 \uc608\uc2dc"),(0,s.kt)("p",null,"\uc608\uc804 \uacfc\uc81c\ub97c \ubcf4\ub2c8\uae4c Access \ud1a0\ud070\uc73c\ub85c body\uc5d0 \uc751\ub2f5\ud569\ub2c8\ub2e4."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-md"},'### \uc751\ub2f5 \uc608\uc2dc\n\n- status: 200 OK\n- body\n\n```json\n{\n  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InRlc3RAZ21haWwuY29tIiwic3ViIjo0LCJpYXQiOjE2NTk5MDQyMTUsImV4cCI6MTY2MDUwOTAxNX0.DyUCCsIGxIl8i_sGFCa3uQcyEDb9dChjbl40h3JWJNc"\n}\n```\n')),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/walking-sunset/selection-task"},"\uc6d0\ud2f0\ub4dc \ud504\ub9ac\uc628\ubcf4\ub529 \ud504\ub860\ud2b8\uc5d4\ub4dc - \uc120\ubc1c \uacfc\uc81c")),(0,s.kt)("p",null,"\uc774\ub807\uac8c \ubcf4\uba74 ",(0,s.kt)("inlineCode",{parentName:"p"},"set-cookie"),"\ub85c \uc751\ub2f5\uc740 refresh \ud1a0\ud070\uc5d0 \uc124\uc815\ud558\uba74 \ub429\ub2c8\ub2e4."),(0,s.kt)("h3",{id:"login"},"login"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/gitdagray/mern_stack_course/blob/main/lesson_13-backend/controllers/authController.js"},"Auth Controller - Dave Gray")),(0,s.kt)("p",null,"\uc774 \uc608\uc2dc\uac00 \uc81c\uc77c \uc9c1\uad00\uc801\uc785\ub2c8\ub2e4."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js"},"const User = require('../models/User');\nconst bcrypt = require('bcrypt');\nconst jwt = require('jsonwebtoken');\n\n// @desc Login\n// @route POST /auth\n// @access Public\nconst login = async (req, res) => {\n  const { username, password } = req.body;\n\n  if (!username || !password) {\n    return res.status(400).json({ message: 'All fields are required' });\n  }\n\n  const foundUser = await User.findOne({ username }).exec();\n\n  if (!foundUser || !foundUser.active) {\n    return res.status(401).json({ message: 'Unauthorized' });\n  }\n\n  const match = await bcrypt.compare(password, foundUser.password);\n\n  if (!match) return res.status(401).json({ message: 'Unauthorized' });\n\n  const accessToken = jwt.sign(\n    {\n      UserInfo: {\n        username: foundUser.username,\n        roles: foundUser.roles,\n      },\n    },\n    process.env.ACCESS_TOKEN_SECRET,\n    { expiresIn: '15m' }\n  );\n\n  const refreshToken = jwt.sign(\n    { username: foundUser.username },\n    process.env.REFRESH_TOKEN_SECRET,\n    { expiresIn: '7d' }\n  );\n\n  // Create secure cookie with refresh token\n  res.cookie('jwt', refreshToken, {\n    httpOnly: true, //accessible only by web server\n    secure: true, //https\n    sameSite: 'None', //cross-site cookie\n    maxAge: 7 * 24 * 60 * 60 * 1000, //cookie expiry: set to match rT\n  });\n\n  // Send accessToken containing username and roles\n  res.json({ accessToken });\n};\n")),(0,s.kt)("p",null,"\ubd80\ubd84\uc744 \ubcf4\uba74 \uc774\ud574\uac00 \ub429\ub2c8\ub2e4. \uc5b4\ub290\uc815\ub3c4 \uc720\ud6a8\uc131\uc744 \uac80\uc99d\ud558\uace0 ",(0,s.kt)("inlineCode",{parentName:"p"},"cookie"),"\uc5d0 ",(0,s.kt)("inlineCode",{parentName:"p"},"refresh token"),"\uc744 \uc124\uc815\ud569\ub2c8\ub2e4. \uadf8\ub9ac\uace0 ",(0,s.kt)("inlineCode",{parentName:"p"},"response body"),"\uc5d0 ",(0,s.kt)("inlineCode",{parentName:"p"},"access token"),"\uc744 \uc751\ub2f5\ud569\ub2c8\ub2e4. \uc751\ub2f5\uc744 \ubc1b\uc740 \ud504\ub860\ud2b8\uc5d4\ub4dc \uc5d4\uc9c0\ub2c8\uc5b4 \uc785\uc7a5\uc5d0\uc11c \uc774 ",(0,s.kt)("inlineCode",{parentName:"p"},"token"),"\uc744 ",(0,s.kt)("inlineCode",{parentName:"p"},"header"),"\uc5d0 \uc124\uc815\ud558\uba74 \ub429\ub2c8\ub2e4."),(0,s.kt)("h3",{id:"refresh"},"refresh"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js"},"// @desc Refresh\n// @route GET /auth/refresh\n// @access Public - because access token has expired\nconst refresh = (req, res) => {\n  const cookies = req.cookies;\n\n  if (!cookies?.jwt) return res.status(401).json({ message: 'Unauthorized' });\n\n  const refreshToken = cookies.jwt;\n\n  jwt.verify(\n    refreshToken,\n    process.env.REFRESH_TOKEN_SECRET,\n    async (err, decoded) => {\n      if (err) return res.status(403).json({ message: 'Forbidden' });\n\n      const foundUser = await User.findOne({\n        username: decoded.username,\n      }).exec();\n\n      if (!foundUser) return res.status(401).json({ message: 'Unauthorized' });\n\n      const accessToken = jwt.sign(\n        {\n          UserInfo: {\n            username: foundUser.username,\n            roles: foundUser.roles,\n          },\n        },\n        process.env.ACCESS_TOKEN_SECRET,\n        { expiresIn: '15m' }\n      );\n\n      res.json({ accessToken });\n    }\n  );\n};\n")),(0,s.kt)("p",null,"accessToken \uac31\uc2e0\ud558\ub294 \ub85c\uc9c1\uc785\ub2c8\ub2e4."),(0,s.kt)("h3",{id:"logout"},"logout"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js"},"// @desc Logout\n// @route POST /auth/logout\n// @access Public - just to clear cookie if exists\nconst logout = (req, res) => {\n  const cookies = req.cookies;\n  if (!cookies?.jwt) return res.sendStatus(204); //No content\n  res.clearCookie('jwt', { httpOnly: true, sameSite: 'None', secure: true });\n  res.json({ message: 'Cookie cleared' });\n};\n\nmodule.exports = {\n  login,\n  refresh,\n  logout,\n};\n")),(0,s.kt)("p",null,"\uc544\uc8fc \uc9c1\uad00\uc801\uc785\ub2c8\ub2e4."),(0,s.kt)("p",null,"\uc774 \uc608\uc2dc\ub294 Node.js \ubc84\uc804\uc785\ub2c8\ub2e4. \uc800\ub294 Deno \ub7f0\ud0c0\uc784\uc5d0 \ub9de\uac8c \ubcc0\ud615\ud574\uc57c \ud569\ub2c8\ub2e4."),(0,s.kt)("h3",{id:"deno-\ubc84\uc804"},"Deno \ubc84\uc804"),(0,s.kt)("p",null,"\ud55c\uac00\uc9c0 \uc798 \ubabb \uc54c\uace0 \uc788\ub358 \uc9c0\uc2dd\uc774 \uc788\uc5c8\uc2b5\ub2c8\ub2e4. \uc81c\uac00 \ub9cc\ub4e4\uc5c8\ub358 \uac83\uc740 \ubbf8\ub4e4\uc6e8\uc5b4\uc785\ub2c8\ub2e4. \ucee8\ud2b8\ub864\ub7ec\uac00 \uc544\ub2d9\ub2c8\ub2e4."),(0,s.kt)("p",null,"\ubbf8\ub4e4\uc6e8\uc5b4\ub294 \uc694\uccad\uacfc \uc751\ub2f5 \uc0ac\uc774 \ucc98\ub9ac\ub97c \ub2f4\ub2f9\ud558\ub294 \ucf54\ub4dc\uc785\ub2c8\ub2e4."),(0,s.kt)("p",null,"\ucee8\ud2b8\ub864\ub7ec\ub294 \ub77c\uc6b0\ud305 \uc694\uccad\uc5d0 \ub300\ud55c \uc2e4\uc81c \ucc98\ub9ac\uacb0\uacfc\ub97c \uad6c\ud604\ud569\ub2c8\ub2e4."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"// util/token.ts\nimport { create, getNumericDate, verify } from '../deps.ts';\n\nclass Token {\n  private static instance: Token;\n  readonly key: Promise<CryptoKey>;\n\n  private constructor() {\n    this.key = (async () => {\n      const key = await crypto.subtle.generateKey(\n        { name: 'HMAC', hash: { name: 'SHA-512' } },\n        true,\n        ['sign', 'verify']\n      );\n      return key;\n    })();\n  }\n\n  static getInstance(): Token {\n    if (!Token.instance) {\n      Token.instance = new Token();\n    }\n    return Token.instance;\n  }\n\n  async makeAccessToken(userId: string, expiresInSec = 3600) {\n    const jwt = await create(\n      { alg: 'HS512' },\n      { exp: getNumericDate(expiresInSec), sub: userId },\n      await this.key\n    );\n    return {\n      jwt,\n      expires: new Date(new Date().getTime() + expiresInSec * 1000),\n    };\n  }\n\n  async makeRefreshToken(userId: string, expiresInSec = 2592000) {\n    const jwt = await create(\n      { alg: 'HS512' },\n      { exp: getNumericDate(expiresInSec), sub: userId },\n      await this.key\n    );\n    return {\n      jwt,\n      expires: new Date(new Date().getTime() + expiresInSec * 1000),\n    };\n  }\n\n  async tokenToUserId(jwt: string) {\n    const { sub } = await verify(jwt, await this.key);\n    return sub;\n  }\n}\n\nexport default Token;\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"// controllers/users.ts\nasync function signin({ request, response, cookies }: Context) {\n  try {\n    if (!request.hasBody) {\n      throw Error('body\uac00 \uc5c6\uc2b5\ub2c8\ub2e4.');\n    }\n\n    const input = await request.body().value;\n    if (!input.email || !input.password) {\n      throw Error('\uc774\uba54\uc77c \ud639\uc740 \ube44\ubc00\ubc88\ud638\uac00 \uc5c6\uc2b5\ub2c8\ub2e4.');\n    }\n\n    const document = await mongoAPI.getUser(input.email);\n    if (document === null) throw Error('\uc774\uba54\uc77c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.');\n    else {\n      if (await compare(input.password, document.passwordHash)) {\n        const { jwt: refreshToken, expires: refreshExpires } =\n          await token.makeRefreshToken(document._id);\n\n        const { jwt: access_token } = await token.makeAccessToken(\n          document._id,\n          60 * 60\n        );\n\n        cookies.set('user', refreshToken, { expires: refreshExpires });\n        response.status = 201;\n        response.body = { access_token };\n      } else {\n        throw Error('\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.');\n      }\n    }\n  } catch (error) {\n    response.status = 400;\n    response.body = {\n      success: false,\n      msg: `${error}`,\n    };\n  }\n}\n")),(0,s.kt)("p",null,"\ub85c\uadf8\uc778 \uae30\ub2a5\uc744 \uad6c\ud604\ud588\uc2b5\ub2c8\ub2e4. \ub2e4\uc74c\uc740 \uc694\uccad\uacfc \uac31\uc2e0 \uae30\ub2a5\uc785\ub2c8\ub2e4."),(0,s.kt)("p",null,"\uba3c\uc800 \uc694\uccad\uc5d0\uc11c access token\uc758 \ub9cc\ub8cc \uac80\uc99d\uc785\ub2c8\ub2e4."),(0,s.kt)("h2",{id:"deps"},"deps"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://deno.com/manual@v1.29.2/examples/manage_dependencies"},"Managing Dependencies - Deno \uacf5\uc2dd \ubb38\uc11c")),(0,s.kt)("p",null,"\uadf8\ub3d9\uc548 \ud558\uace0 \uc2f6\uc5c8\ub358 \ub9ac\ud329\ud1a0\ub9c1\uc744 \ud588\uc2b5\ub2c8\ub2e4. \ubaa8\ub4e0 \uc758\uc874\uc131\uc744 \ud558\ub098\uc758 \ubaa8\ub4c8\uc5d0 \ubab0\uc544 \ub123\uc5c8\uc2b5\ub2c8\ub2e4."),(0,s.kt)("p",null,"\ub9c9\uc0c1 \ud574\ubcf4\ub2c8\uae4c \ubcc4\ub85c \uc5b4\ub824\uc6b4 \uc791\uc5c5\uc774 \uc544\ub2c8\uc5c8\uc2b5\ub2c8\ub2e4."))}k.isMDXComponent=!0}}]);