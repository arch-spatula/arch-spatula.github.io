"use strict";(self.webpackChunkarch_spatula_github_io=self.webpackChunkarch_spatula_github_io||[]).push([[21604],{58151:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var t=s(85893),r=s(11151);const a={title:"\ud1a0\ud070 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131",authors:["arch-spatula"],tags:["token","testing","refactoring"],description:"\ud1a0\ud070\uc744 \uc0dd\uc131, \uac80\uc99d\ud558\ub294 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub97c \uc791\uc131\ud558\ub294 \ubc29\ubc95\uc785\ub2c8\ub2e4. token\uc744 \uc2f1\uae00\ud2bc\uc73c\ub85c \uc81c\uc5b4\ud558\ub294 \uac83\uc740 \uc77c\ubc18\uc801\uc774\uc9c0 \uc54a\uc740 \ud328\ud134\uc785\ub2c8\ub2e4. \uc774\ubd80\ubd84\uc744 \ub9ac\ud329\ud1a0\ub9c1\ud558\uace0 \ud14c\uc2a4\ud2b8\ud569\ub2c8\ub2e4.",toc_max_heading_level:6},o="\ud1a0\ud070 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131",c={permalink:"/blog/2023/06/05/token-testing",editUrl:"https://github.com/arch-spatula/arch-spatula.github.io/blob/dev/blog/2023-06-05-token-testing.md",source:"@site/blog/2023-06-05-token-testing.md",title:"\ud1a0\ud070 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131",description:"\ud1a0\ud070\uc744 \uc0dd\uc131, \uac80\uc99d\ud558\ub294 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub97c \uc791\uc131\ud558\ub294 \ubc29\ubc95\uc785\ub2c8\ub2e4. token\uc744 \uc2f1\uae00\ud2bc\uc73c\ub85c \uc81c\uc5b4\ud558\ub294 \uac83\uc740 \uc77c\ubc18\uc801\uc774\uc9c0 \uc54a\uc740 \ud328\ud134\uc785\ub2c8\ub2e4. \uc774\ubd80\ubd84\uc744 \ub9ac\ud329\ud1a0\ub9c1\ud558\uace0 \ud14c\uc2a4\ud2b8\ud569\ub2c8\ub2e4.",date:"2023-06-05T00:00:00.000Z",formattedDate:"2023\ub144 6\uc6d4 5\uc77c",tags:[{label:"token",permalink:"/blog/tags/token"},{label:"testing",permalink:"/blog/tags/testing"},{label:"refactoring",permalink:"/blog/tags/refactoring"}],readingTime:10.53,hasTruncateMarker:!0,authors:[{name:"arch-spatula",title:"Cook-Book \ub9ce\uc774 \ub9cc\ub4ed\ub2c8\ub2e4",url:"https://github.com/arch-spatula",imageURL:"https://github.com/arch-spatula.png",key:"arch-spatula"}],frontMatter:{title:"\ud1a0\ud070 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc \uc791\uc131",authors:["arch-spatula"],tags:["token","testing","refactoring"],description:"\ud1a0\ud070\uc744 \uc0dd\uc131, \uac80\uc99d\ud558\ub294 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub97c \uc791\uc131\ud558\ub294 \ubc29\ubc95\uc785\ub2c8\ub2e4. token\uc744 \uc2f1\uae00\ud2bc\uc73c\ub85c \uc81c\uc5b4\ud558\ub294 \uac83\uc740 \uc77c\ubc18\uc801\uc774\uc9c0 \uc54a\uc740 \ud328\ud134\uc785\ub2c8\ub2e4. \uc774\ubd80\ubd84\uc744 \ub9ac\ud329\ud1a0\ub9c1\ud558\uace0 \ud14c\uc2a4\ud2b8\ud569\ub2c8\ub2e4.",toc_max_heading_level:6},unlisted:!1,prevItem:{title:"\ubc31\uc5d4\ub4dc \ub9c8\ubb34\ub9ac?",permalink:"/blog/2023/06/06/"},nextItem:{title:"22\uc8fc\ucc28 - \ud14c\ud06c \ud2b8\ub80c\ub4dc \uc90d\uc90d",permalink:"/blog/2023/06/04/"}},i={authorsImageUrls:[void 0]},l=[{value:"Deno \uacf5\uc2dd\ubb38\uc11c",id:"deno-\uacf5\uc2dd\ubb38\uc11c",level:2},{value:"\ud53c\ub4dc\ubc31",id:"\ud53c\ub4dc\ubc31",level:2},{value:"\ub9ac\ud329\ud1a0\ub9c1",id:"\ub9ac\ud329\ud1a0\ub9c1",level:2},{value:"\ubbf8\ub4e4\uc6e8\uc5b4\uac00 \ucc98\ub9ac\ud55c \ub370\uc774\ud130\ub97c \ub118\uaca8\uc8fc\ub294 \ubc29\ubc95",id:"\ubbf8\ub4e4\uc6e8\uc5b4\uac00-\ucc98\ub9ac\ud55c-\ub370\uc774\ud130\ub97c-\ub118\uaca8\uc8fc\ub294-\ubc29\ubc95",level:2},{value:"\uc11c\ubc84\ud074\ub77c\uc774\uc5b8\ud2b8 \uc554\ud638\ud654 \ubcf5\ud638\ud654",id:"\uc11c\ubc84\ud074\ub77c\uc774\uc5b8\ud2b8-\uc554\ud638\ud654-\ubcf5\ud638\ud654",level:2}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"\ud1a0\ud070\uc744 \uc0dd\uc131, \uac80\uc99d\ud558\ub294 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub97c \uc791\uc131\ud558\ub294 \ubc29\ubc95\uc785\ub2c8\ub2e4. token\uc744 \uc2f1\uae00\ud2bc\uc73c\ub85c \uc81c\uc5b4\ud558\ub294 \uac83\uc740 \uc77c\ubc18\uc801\uc774\uc9c0 \uc54a\uc740 \ud328\ud134\uc785\ub2c8\ub2e4. \uc774\ubd80\ubd84\uc744 \ub9ac\ud329\ud1a0\ub9c1\ud558\uace0 \ud14c\uc2a4\ud2b8\ud569\ub2c8\ub2e4."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"import { create, getNumericDate, verify } from '../deps.ts';\n\nclass Token {\n  private static instance: Token;\n  readonly key: Promise<CryptoKey>;\n\n  private constructor() {\n    this.key = (async () => {\n      const key = await crypto.subtle.generateKey(\n        { name: 'HMAC', hash: { name: 'SHA-512' } },\n        true,\n        ['sign', 'verify']\n      );\n      return key;\n    })();\n  }\n\n  static getInstance(): Token {\n    if (!Token.instance) {\n      Token.instance = new Token();\n    }\n    return Token.instance;\n  }\n\n  async makeAccessToken(userId: string, expiresInSec = 3600) {\n    const jwt = await create(\n      { alg: 'HS512' },\n      { exp: getNumericDate(expiresInSec), sub: userId },\n      await this.key\n    );\n    return {\n      jwt,\n      expires: new Date(new Date().getTime() + expiresInSec * 1000),\n    };\n  }\n\n  async makeRefreshToken(userId: string, expiresInSec = 2592000) {\n    const jwt = await create(\n      { alg: 'HS512' },\n      { exp: getNumericDate(expiresInSec), sub: userId },\n      await this.key\n    );\n    return {\n      jwt,\n      expires: new Date(new Date().getTime() + expiresInSec * 1000),\n    };\n  }\n\n  async refreshAccessToken(refreshToken: string) {\n    try {\n      const userId = await this.tokenToUserId(refreshToken);\n\n      if (!userId) throw new Error('\ud1a0\ud070\uc774 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4.');\n\n      const { jwt: accessToken } = await this.makeAccessToken(userId);\n      return { accessToken, success: true };\n    } catch (error) {\n      return { accessToken: null, success: false };\n    }\n  }\n\n  async tokenToUserId(jwt: string) {\n    const { sub } = await verify(jwt, await this.key, {});\n    return sub;\n  }\n}\n\nexport default Token;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\uc774\ub7f0 \ud1a0\ud070 \ud074\ub798\uc2a4\uac00 \uc788\uc2b5\ub2c8\ub2e4. \ucc38\uace0\ub85c ",(0,t.jsx)(n.code,{children:"private"})," \ud0a4\ub294 \uac1c\ubc1c\uc790\uc778 \uc800\ub3c4 \ubaa8\ub974\uac8c \ub9cc\ub4e4\uc5c8\uc2b5\ub2c8\ub2e4. \uc774\uac74 \uc911\uc694\ud55c \uac83\uc774 \uc544\ub2d9\ub2c8\ub2e4."]}),"\n",(0,t.jsx)(n.p,{children:"\uc911\uc694\ud55c \uac83\uc740 \uc774\uac83\uc744 \uc5b4\ub5bb\uac8c \ud14c\uc2a4\ud2b8\ud558\ub294\uac00?"}),"\n",(0,t.jsx)(n.p,{children:"\ud14c\uc2a4\ud2b8\ud574\ubcfc \uc9c0\uc810\ub4e4\uc744 \uc0dd\uac01\ud574\ubd05\uc2dc\ub2e4. \uba3c\uc800 \uc2f1\uae00\ud2bc \ud328\ud134\uc774\uae30 \ub54c\ubb38\uc5d0 \ub458\uc774 \uac19\uc740 \uba54\ubaa8\ub9ac \uc8fc\uc18c\ub97c \uacf5\uc720\ud558\ub294\uc9c0 \uac80\uc99d\uc774 \ud544\uc694\ud569\ub2c8\ub2e4. \ud1a0\ud070\uc774 \ub9cc\ub4e4\uc5b4\uc9c0\ub294\uc9c0 2\uac1c\uc758 \uba54\uc11c\ub4dc\ub97c \ud14c\uc2a4\ud2b8\ud574\ubcfc \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ud1a0\ud070\uc744 \uac31\uc2e0\ud558\ub294 \ud568\uc218\uc5d0 2\uac00\uc9c0 \uacbd\uc6b0\uc758 \uc218\ub97c \ud14c\uc2a4\ud2b8 \ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ub9cc\ub8cc, \uc720\ud6a8 2\uac00\uc9c0\ub85c \uac31\uc2e0\ud574\uc11c \uc751\ub2f5\ud558\ub294\uc9c0 \ud655\uc778\ud574\ubcfc \uc218 \uc788\uc2b5\ub2c8\ub2e4. \ub9c8\uc9c0\ub9c9\uc73c\ub85c token\uc774 userId\ub85c \ubcc0\ud658\ud574\uc8fc\ub294\uc9c0 \ub610\ub294 \uc2e4\ud328\ud558\uba74 \uc5b4\ub5bb\uac8c \ucc98\ub9ac\ud560\uc9c0 \uac80\uc99d\ud574\ubcfc \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","2\uac1c \uc0dd\uc131 \uac19\uc740 \uc778\uc2a4\ud134\uc2a4"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\ub9ac\ud329\ud1a0\ub9c1"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","makeRefreshToken"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","makeAccessToken"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","refreshAccessToken","\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\uc720\ud6a8"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\ub9cc\ub8cc"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","tokenToUserId","\n",(0,t.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\uc720\ud6a8"]}),"\n",(0,t.jsxs)(n.li,{className:"task-list-item",children:[(0,t.jsx)(n.input,{type:"checkbox",disabled:!0})," ","\ub9cc\ub8cc"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\uc5ec\uae30\uae4c\uc9c0\ub294 \ud14c\uc2a4\ud2b8 \uc124\uacc4\uc785\ub2c8\ub2e4."}),"\n",(0,t.jsx)(n.p,{children:"\ub2e4\uc74c \ubb38\uc81c\ub294 Deno\uac00 \uc81c\uacf5\ud558\ub294 \ud14c\uc2a4\ud2b8 \ub3c4\uad6c\ub97c \uc5b4\ub5bb\uac8c \uc798 \ud65c\uc6a9\ud560 \uc218 \uc788\ub294\uc9c0 \uace0\ubbfc\uc785\ub2c8\ub2e4. \uc7a0\uc2dc \uacf5\uc2dd \ubb38\uc11c\ub97c \uc21c\uc11c\ub300\ub85c \uc77d\uc5b4\uc57c \ud569\ub2c8\ub2e4."}),"\n",(0,t.jsx)(n.h2,{id:"deno-\uacf5\uc2dd\ubb38\uc11c",children:"Deno \uacf5\uc2dd\ubb38\uc11c"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://deno.com/manual@v1.34.1/basics/testing",children:"Testing - Deno"})}),"\n",(0,t.jsx)(n.h2,{id:"\ud53c\ub4dc\ubc31",children:"\ud53c\ub4dc\ubc31"}),"\n",(0,t.jsx)(n.p,{children:"token\uc744 \uc2f1\uae00\ud2bc\uc73c\ub85c \uc791\uc131\ud574\uc11c \uc790\uc6d0\uacf5\uc720\ud558\ub294 \uc811\uadfc\uc5d0 \ub2e8\uc810\uc774 \uc788\uc2b5\ub2c8\ub2e4. \ucf54\ub4dc \uc2a4\uba5c\uc785\ub2c8\ub2e4. \uc0dd\uac01\uc790\uccb4\uac00 \ub098\uc05c \uac83\uc740 \uc544\ub2d9\ub2c8\ub2e4. \ud558\uc9c0\ub9cc \uc2e4\uc81c\ub85c \ub9cc\ub4e4\uace0\ub098\uc11c \ud14c\uc2a4\ud2b8\ucf54\ub4dc \uc791\uc131\uc774 \uc5b4\ub824\uc6b0\uba74 \ucf54\ub4dc \uc2a4\uba5c\uc774 \uc788\ub2e4\uace0 \ubcfc \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ub7f0 \uc774\uc720\ub85c \uc2f1\uae00\ud2bc \ud328\ud134\uc5d0\uc11c \ud574\uccb4\ud574\uc57c \ud569\ub2c8\ub2e4."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"import { assertEquals } from '../deps.ts';\nimport {\n  convertTokenToUserId,\n  generateAccessToken,\n  generateKey,\n  generateRefreshToken,\n  refreshAccessToken,\n} from './token.ts';\n\nDeno.test('should return access token', async () => {\n  const privateKey = generateKey();\n  const userId = 'user123';\n  const expiresInSec = 3600;\n\n  const result = await generateAccessToken(privateKey, userId, expiresInSec);\n\n  assertEquals(typeof result.jwt, 'string');\n  assertEquals(typeof result.expires, 'object');\n});\n\nDeno.test('should return refresh token', async () => {\n  const privetKey = generateKey();\n  const userId = 'user123';\n  const expiresInSec = 3600;\n\n  const result = await generateRefreshToken(privetKey, userId, expiresInSec);\n\n  assertEquals(typeof result.jwt, 'string');\n  assertEquals(typeof result.expires, 'object');\n});\n\nDeno.test('should refresh access token', async () => {\n  const privetKey = generateKey();\n  const userId = 'userId123';\n  const refreshToken = (await generateRefreshToken(privetKey, userId)).jwt;\n\n  const result = await refreshAccessToken(privetKey, refreshToken);\n\n  assertEquals(typeof result.accessToken, 'string');\n  assertEquals(result.success, true);\n});\n\nDeno.test('should convert token as userId', async () => {\n  const privateKey = generateKey();\n  const userId = 'userId123';\n  const accessToken = (await generateAccessToken(privateKey, userId)).jwt;\n\n  const result = await convertTokenToUserId(privateKey, accessToken);\n\n  assertEquals(result, userId);\n});\n"})}),"\n",(0,t.jsx)(n.p,{children:"\uc77c\ub2e8 \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\ub97c \ud568\uc218\ub85c \ubaa8\ub450 \ubd84\ub9ac\ud574\uc11c \uc791\uc131\ud588\uc2b5\ub2c8\ub2e4. \uadf8\ub9ac\uace0 \ubcf4\uc644\ud560 \uc810\ub4e4\uc744 \ud53c\ub4dc\ubc31\ubc1b\uc558\uc2b5\ub2c8\ub2e4."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\uc2e4\ud328 \uc2dc\uc5d0 \ub300\ud55c \ucd94\uac00 \uc815\ubcf4: \ud14c\uc2a4\ud2b8 \ucf54\ub4dc\uc5d0 \uc2e4\ud328\ud55c \uacbd\uc6b0 \uc5b4\ub5a4 \ubd80\ubd84\uc5d0\uc11c \uc2e4\ud328\ud588\ub294\uc9c0 \uc790\uc138\ud55c \uc815\ubcf4\ub97c \uc81c\uacf5\ud558\ub294 \uac83\uc774 \ub3c4\uc6c0\uc774 \ub420 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc2e4\ud328 \uba54\uc2dc\uc9c0\uc5d0 \ucd94\uac00 \uc815\ubcf4\ub97c \ud3ec\ud568\uc2dc\ucf1c \uc5b4\ub5a4 \uc870\uac74\uc774 \uc2e4\ud328\ud588\ub294\uc9c0 \ub354 \uc27d\uac8c \uc774\ud574\ud560 \uc218 \uc788\ub3c4\ub85d \ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\uacbd\uacc4 \uc870\uac74 \ud14c\uc2a4\ud2b8: \uc785\ub825\uac12\uc758 \uacbd\uacc4 \uc870\uac74\uc744 \ud14c\uc2a4\ud2b8\ud558\ub294 \ucf00\uc774\uc2a4\ub97c \ucd94\uac00\ud558\ub294 \uac83\uc774 \uc88b\uc2b5\ub2c8\ub2e4. \uc608\ub97c \ub4e4\uc5b4, \ud1a0\ud070 \ub9cc\ub8cc \uc2dc\uac04\uc774 0\uc774\ub098 \ub9e4\uc6b0 \ud070 \uac12\uc744 \uac00\uc9c0\ub294 \uacbd\uc6b0\ub97c \ud14c\uc2a4\ud2b8\ud558\uc5ec \uc608\uc0c1\ud55c \ub3d9\uc791\uc744 \ud655\uc778\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\ubaa8\uc758 \uac1d\uccb4 \uc0ac\uc6a9: \ud14c\uc2a4\ud2b8\ud560 \ud568\uc218\uac00 \uc678\ubd80 \uc758\uc874\uc131\uc744 \uac00\uc9c8 \ub54c, \ubaa8\uc758 \uac1d\uccb4(Mock Object)\ub97c \uc0ac\uc6a9\ud558\uc5ec \uc678\ubd80 \uc758\uc874\uc131\uc744 \ub300\uccb4\ud558\uace0 \ud14c\uc2a4\ud2b8\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. \uc774\ub97c \ud1b5\ud574 \uc678\ubd80 \ub9ac\uc18c\uc2a4\uc5d0 \uc758\uc874\ud558\uc9c0 \uc54a\uace0 \ud14c\uc2a4\ud2b8\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\uc608\uc678 \ucc98\ub9ac \ud14c\uc2a4\ud2b8: \uc608\uc678 \uc0c1\ud669\uc5d0 \ub300\ud55c \ud14c\uc2a4\ud2b8\ub3c4 \ucd94\uac00\ud558\ub294 \uac83\uc774 \uc88b\uc2b5\ub2c8\ub2e4. \uc608\ub97c \ub4e4\uc5b4, \uc720\ud6a8\ud558\uc9c0 \uc54a\uc740 \ud1a0\ud070\uc774\ub098 \uc798\ubabb\ub41c \uc785\ub825\uc5d0 \ub300\ud55c \uc608\uc678 \ucc98\ub9ac\ub97c \ud14c\uc2a4\ud2b8\ud558\uc5ec \ucf54\ub4dc\uc758 \uc548\uc815\uc131\uc744 \uac80\uc99d\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\ub9ac\ud329\ud1a0\ub9c1",children:"\ub9ac\ud329\ud1a0\ub9c1"}),"\n",(0,t.jsx)(n.p,{children:"\ud14c\uc2a4\ud2b8\ud558\uae30 \uc88b\ub2e4\uace0 \uc88b\uc740 \ucf54\ub4dc\ub294 \uc544\ub2c8\ub2e4. \ud558\uc9c0\ub9cc \ud14c\uc2a4\ud2b8\ud558\uae30\ub3c4 \uc5b4\ub824\uc6b0\uba74 \ub098\uc05c \ucf54\ub4dc\ub2e4."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"const authMiddleware: Middleware = async (\n  { request, response, cookies },\n  next\n) => {\n  try {\n    const jwt = request.headers.get('Authorization')!;\n    if (!jwt || !jwt.startsWith('Bearer '))\n      throw new AuthorizationError('Unauthorized');\n\n    const userId = await convertTokenToUserId(jwt);\n\n    if (!userId) {\n      const refreshToken = await cookies.get('user');\n      if (!refreshToken) throw new AuthorizationError('logout');\n\n      response.status = 401;\n      response.body = {\n        success: false,\n        msg: '\ud1a0\ud070\uc774 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4',\n        accessToken: await refreshAccessToken(refreshToken, privateKey),\n      };\n      cookies.set(\n        'user',\n        (await refreshAccessToken(refreshToken, privateKey)).accessToken\n      );\n      return;\n    }\n\n    request.headers.append('userId', userId);\n    await next();\n  } catch (error) {\n    if (error instanceof AuthorizationError) {\n      response.status = 400;\n      response.body = {\n        error,\n        success: false,\n      };\n    } else {\n      response.status = 401;\n      response.body = {\n        error,\n        success: false,\n      };\n    }\n  }\n};\n\nexport { authMiddleware };\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"Deno.test(\n  'should pass with validate access token and refresh token',\n  async () => {\n    // given\n    const privateKey = generateKey();\n    const userId = 'userId123';\n    const expiresInSec = 3600;\n    const { jwt: accessToken } = await generateAccessToken(\n      userId,\n      expiresInSec,\n      privateKey\n    );\n    const { jwt: refreshCookie } = await generateRefreshToken(\n      userId,\n      expiresInSec,\n      privateKey\n    );\n    const ctx = testing.createMockContext({\n      headers: [['cookie', `user=${refreshCookie}`]],\n    });\n    ctx.request.headers.set('Authorization', accessToken);\n    const next = testing.createMockNext();\n\n    // when\n    await authMiddleware(ctx, next);\n\n    //then\n    assertEquals(\n      [...ctx.request.headers],\n      [\n        ['authorization', accessToken],\n        ['cookie', `user=${refreshCookie}`],\n        ['userId', userId],\n      ]\n    );\n    assert(ctx.request.headers.has('userId'), 'should have userId');\n  }\n);\n\nDeno.test('should return new refresh token', async () => {\n  const refreshCookie = 'refreshToken';\n  const ctx = testing.createMockContext({\n    headers: [\n      ['Authorization', ''],\n      ['cookie', `user=${refreshCookie}`],\n    ],\n  });\n  const next = testing.createMockNext();\n\n  await authMiddleware(ctx, next);\n\n  assert(ctx.response.status === 400, '400');\n  assertEquals(\n    ctx.response.body,\n    {\n      msg: '\ud1a0\ud070\uc774 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4.',\n      accessToken: Promise.resolve({ accessToken: null, success: false }),\n    },\n    'access token \uac31\uc2e0 \uc751\ub2f5'\n  );\n});\n\nDeno.test({\n  name: '\ubaa8\ub4e0 Token\uc774 \ub9cc\ub8cc',\n  async fn() {\n    const ctx = testing.createMockContext({\n      headers: [['Authorization', '']],\n    });\n    await ctx.cookies.set('user', null);\n    const next = testing.createMockNext();\n\n    await authMiddleware(ctx, next);\n\n    assert(ctx.response.status === 400, '400');\n    assertEquals(ctx.response.body, { msg: '\ub85c\uadf8\uc544\uc6c3 \ub418\uc5c8\uc2b5\ub2c8\ub2e4.' });\n  },\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\ubbf8\ub4e4\uc6e8\uc5b4\uac00-\ucc98\ub9ac\ud55c-\ub370\uc774\ud130\ub97c-\ub118\uaca8\uc8fc\ub294-\ubc29\ubc95",children:"\ubbf8\ub4e4\uc6e8\uc5b4\uac00 \ucc98\ub9ac\ud55c \ub370\uc774\ud130\ub97c \ub118\uaca8\uc8fc\ub294 \ubc29\ubc95"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"TypeError: Headers are immutable."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"const authMiddleware: Middleware = async (\n  { request, response, cookies, state },\n  next\n) => {\n  try {\n    const refreshToken = request.headers.get('Authorization');\n    const accessToken = await cookies.get('user');\n    if (!refreshToken || !refreshToken.startsWith('Bearer ') || !accessToken)\n      throw new BadRequestError('Bad Request');\n\n    const userId = await convertTokenToUserId(accessToken, privateKey);\n    if (!userId) {\n      const isNotExpired = await convertTokenToUserId(refreshToken, privateKey);\n      if (!isNotExpired) {\n        throw new AuthorizationError('Unauthorized');\n      }\n\n      const { accessToken } = await refreshAccessToken(\n        refreshToken,\n        privateKey\n      );\n      response.status = 401;\n      response.body = {\n        success: false,\n        mag: 'new token is required',\n      };\n      cookies.set('user', accessToken);\n      return;\n    }\n\n    state.userId = userId; // \uc5ec\uae30\uc11c state\uc5d0 \uc4f0\uae30\ub85c \ub118\uaca8 \uc90d\ub2c8\ub2e4. \ub2e4\uc74c \ubbf8\ub4e4\uc6e8\uc5b4\ub294 state\uc5d0 \uc77d\uc73c\uba74 \ub429\ub2c8\ub2e4.\n    await next();\n  } catch (error) {\n    if (error instanceof BadRequestError) {\n      response.status = 400;\n      response.body = {\n        success: false,\n        msg: `${error}`,\n      };\n    } else if (error instanceof AuthorizationError) {\n      response.status = 401;\n      response.body = {\n        success: false,\n        msg: `${error}`,\n      };\n    } else {\n      response.status = 406;\n      response.body = {\n        success: false,\n        msg: `${error}`,\n      };\n    }\n  }\n};\n\nexport { authMiddleware };\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\uc11c\ubc84\ud074\ub77c\uc774\uc5b8\ud2b8-\uc554\ud638\ud654-\ubcf5\ud638\ud654",children:"\uc11c\ubc84\ud074\ub77c\uc774\uc5b8\ud2b8 \uc554\ud638\ud654 \ubcf5\ud638\ud654"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"TypeError: Cannot send secure cookie over unencrypted connection."}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"async function signin({ request, response, cookies }: Context) {\n  try {\n    if (!request.hasBody) {\n      throw Error('body\uac00 \uc5c6\uc2b5\ub2c8\ub2e4.');\n    }\n\n    const input = await request.body().value;\n    if (!input.email || !input.password) {\n      throw Error('\uc774\uba54\uc77c \ud639\uc740 \ube44\ubc00\ubc88\ud638\uac00 \uc5c6\uc2b5\ub2c8\ub2e4.');\n    }\n\n    const document = await mongoAPI.getUser(input.email);\n    if (document === null) throw Error('\uc774\uba54\uc77c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.');\n    else {\n      if (await compare(input.password, document.passwordHash)) {\n        const { jwt: refreshToken, expires: refreshExpires } =\n          await generateRefreshToken(document._id);\n\n        const { jwt: access_token } = await generateAccessToken(\n          document._id,\n          60 * 60\n        );\n\n        cookies.set('user', refreshToken, {\n          expires: refreshExpires,\n          httpOnly: true,\n          // secure: true, \uc554\ud638\ud654 \ubc29\uc2dd \ucc3e\uace0 \uc8fc\uc11d\uc744 \ud480\uc5b4\uc8fc\uc138\uc694\n        });\n        response.status = 201;\n        response.body = {\n          success: true,\n          access_token,\n        };\n      } else {\n        throw Error('\ube44\ubc00\ubc88\ud638\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.');\n      }\n    }\n  } catch (error) {\n    response.status = 400;\n    response.body = {\n      success: false,\n      msg: `${error}`,\n    };\n  }\n}\n\nexport { signup, signin };\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"secure: true"})," \uc124\uc815\uc744 \ud558\ub824\uba74 \uc554\ud638\ud654\ud558\uace0 \ubcf5\ud638\ud654\uac00 \ud544\uc694\ud569\ub2c8\ub2e4. \uc7a0\uc2dc \ubcf4\ub958 \ucc98\ub9ac\ud558\ub3c4\ub85d \ud558\uaca0\uc2b5\ub2c8\ub2e4. \ubb3c\ub860 \uc0dd\uac01\ud574\ubcf4\uba74 \uc0dd\uac01\ubcf4\ub2e4 \uc11c\ubc84 \ubd80\ud558\uac00 \ud074 \uac83 \uac19\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4. \uac00\ub054 \ud1a0\ud070\uc744 \ud655\uc778\ud574\uc57c \ud558\uae30 \ub54c\ubb38\uc5d0 \uc124\uc815\uc774 \ud544\uc694\ud569\ub2c8\ub2e4. \ub098\uc911\uc5d0 \ucc98\ub9ac\ud558\ub3c4\ub85d \ud558\uaca0\uc2b5\ub2c8\ub2e4."]})]})}function d(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},11151:(e,n,s)=>{s.d(n,{Z:()=>c,a:()=>o});var t=s(67294);const r={},a=t.createContext(r);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);